<%#-- copyright
OpenProject is a project management system.
Copyright (C) 2012-2017 the OpenProject Foundation (OPF)

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License version 3.

OpenProject is a fork of ChiliProject, which is a fork of Redmine. The copyright follows:
Copyright (C) 2006-2017 Jean-Philippe Lang
Copyright (C) 2010-2013 the ChiliProject Team

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

See doc/COPYRIGHT.rdoc for more details.

++#%>
<% content_for :header_tags do %>
  <%= javascript_include_tag "project/description_handling.js" %>
  <%= javascript_include_tag "project/filters.js" %>
<% end %>

<% html_title(t(:label_project_plural)) -%>

<%= toolbar title: t(:label_project_plural) do %>
  <% if User.current.allowed_to?(:add_project, nil, global: true) %>
    <li class="toolbar-item">
      <%= link_to new_project_path,
                  { class: 'button -alt-highlight',
                    aria: {label: t(:label_project_new)},
                    title: t(:label_project_new) } do %>
        <%= op_icon('button--icon icon-add') %>
        <span class="button--text"><%= Project.model_name.human %></span>
      <% end %>
    </li>
  <% end %>
  <li class="toolbar-item">
    <button id="projects-filter-toggle-button" title="<%= t(:label_filters_toggle) %>" class="button toolbar-icon <%= filter_set? ? '-active' : '' %>">
      <op-icon icon-classes="icon-filter button--icon"></op-icon>
    </button>
  </li>
  <li class="toolbar-item">
    <%= link_to t(:label_overall_activity), activities_path, class: 'button' %>
  </li>
<% end %>

<%= render partial: 'projects/filters/form', locals: { query: @query } %>

<% if @projects.any? %>
  <div class="generic-table--container">
    <div class="generic-table--results-container">
      <table class="generic-table" id="project-table">
        <thead>
          <tr>
            <%= sort_header_tag('name', caption: Project.model_name.human, param: :sortBy) %>
            <%= sort_header_tag('is_public', caption: Project.human_attribute_name(:is_public), param: :sortBy) %>
            <% if EnterpriseToken.allows_to?(:custom_fields_in_projects_list) %>
              <% @custom_fields.each do |custom_field| %>
                <%= sort_header_tag("cf_#{custom_field.id}", caption: custom_field.name, param: :sortBy) %>
              <% end %>
            <% end %>
            <% if User.current.admin? %>
              <%= sort_header_tag('required_disk_space', caption: I18n.t(:label_required_disk_storage), param: :sortBy) %>
              <%= sort_header_tag('created_on', caption: Project.human_attribute_name(:created_on), param: :sortBy) %>
              <%= sort_header_tag('latest_activity_at', caption: Project.human_attribute_name(:latest_activity_at), param: :sortBy) %>
            <% end %>
            <th class="-right">
              <div class="generic-table--header-outer">
                <div class="generic-table--header">
                  <% if params[:expand] == 'all' %>
                    <%= link_to t(:button_collapse_all), { params: safe_query_params(%w{filters page per_page sort}).except(:expand) } %>
                  <% else %>
                    <%= link_to t(:button_expand_all), { params: safe_query_params(%w{filters page per_page sort}).merge(expand: 'all') } %>
                  <% end %>
                </div>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <% projects_with_level(@projects) do |project, level| %>
            <tr class="basics context-menu--reveal <%= project_css_classes(project, ignore_hierarchy: level == 0) %> <%= level > 0 ? "idnt idnt-#{level}" : nil %> <%= params[:expand] == 'all' && project.short_description.present? ? '-no-highlighting -expanded' : '' %>">
              <td class="name project--hierarchy <%= project.archived? ? 'archived' : '' %>">
                <% if project.archived? %>
                  <span class="archived-label"><%= t('project.archive.archived') %></span>
                <% end %>
                <%= link_to_project(project, {}, {}, false) %>
              </td>
              <td><%= checked_image project.is_public? %></td>
              <% if EnterpriseToken.allows_to?(:custom_fields_in_projects_list) %>
                <% @custom_fields.each do |custom_field| %>
                  <% if project.custom_value_for(custom_field).present? %>
                    <td class="format-<%= custom_field.field_format %>">
                      <% if custom_field.field_format == 'text' %>
                        <%= shorten_text(project.custom_value_for(custom_field).formatted_value, 20) %>
                      <% else %>
                        <%= project.custom_value_for(custom_field).formatted_value %>
                      <% end %>
                    </td>
                  <% else %>
                    <td></td>
                  <% end %>
                <% end %>
              <% end %>
              <% if User.current.admin? %>
                <td><%= number_to_human_size(project.required_disk_space, precision: 2) if project.required_disk_space.to_i > 0 %></td>
                <td><%= format_date(project.created_on) %></td>
                <td><%= format_date(project.latest_activity_at) %></td>
              <% end %>
              <td class="buttons">
                <% items = project_more_menu_items(project) %>
                <% if items.any?  %>
                  <%# toolbar and legacy-actions-more are only for styling purposes.
                      Because of multiple diverging implementations of dropdowns the
                      normal dropdown classes cannot be used any more without making special rules %>
                  <ul class="toolbar project-actions">
                    <li aria-haspopup="true" title="<%= t(:label_open_menu) %>" class="drop-down">
                      <a class="icon icon-show-more-horizontal context-menu--icon" title="<%= t(:label_open_menu) %>" href></a>
                      <ul style="display:none;" class="legacy-actions-more dropdown-menu">
                        <% items.each do |item| %>
                          <li>
                            <%= link_to(*item) %>
                          </li>
                        <% end %>
                      </ul>
                    </li>
                  </ul>
                <% end %>
                <% unless project.description.blank? %>
                  <a class="icon collapse icon-arrow-up1 projects-table--description-toggle" href title="<%= t('label_project_hide_details') %>" onclick="toggleDescription(this);"></a>
                  <a class="icon expand icon-arrow-down1 projects-table--description-toggle" href title="<%= t('label_project_show_details') %>" onclick="toggleDescription(this);"></a>
                <% end %>
              </td>
            </tr>
            <% unless project.description.blank? %>
              <tr class="project-description <%= project_css_classes(project) %> <%= level > 0 ? "idnt idnt-#{level}" : nil %> <%= params[:expand] == 'all' ? '-expanded' : '' %>">
                <td colspan="<%= @custom_fields.size + (User.current.admin? ? 6 : 3) %>" class="project--hierarchy">
                  <div class="description-container">
                    <span class="wiki"><%= format_text(project.short_description(255), project: project) %></span>
                  </div>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>

      <%= pagination_links_full @projects %>
    </div>
  </div>
<% else %>
  <%= no_results_box(action_url: new_project_path, display_action: true) %>
<% end %>

<% if User.current.admin? %>
  <p class="information-section">
    <%= op_icon('icon-info1') %>
    <%= t(:label_projects_storage_information,
          count: Project.count,
          storage: number_to_human_size(Project.total_projects_size, precision: 2)) %>
  </p>
<% end %>
